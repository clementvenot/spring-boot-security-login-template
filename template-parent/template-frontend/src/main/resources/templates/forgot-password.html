<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="#{page.forgotpwd.title}">Forgot Password</title>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    main { max-width: 420px; margin: 0 auto; }
    h1 { margin-bottom: .5rem; }
    p.muted { color: #6b7280; margin-top: 0; }
    form { display: grid; gap: .75rem; margin-top: 1rem; }
    label { display: grid; gap: .35rem; }
    input { padding: .6rem .75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: .5rem; }
    button { padding: .6rem .9rem; font-size: 1rem; border-radius: .5rem;
             border: 1px solid transparent; background: #2563eb; color: white; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    .alert { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #f5c6cb;
             background: #fdecea; color: #611a15; }
    .ok { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #84e1bc;
          background: #e6ffed; color: #03543f; }
    .links { margin-top: .75rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<body>
<main>

  <!-- Lang switch -->
  <nav style="margin:.5rem 0 1rem">
    <a th:href="@{/forgot-password(lang=${'fr'})}">FR</a> |
    <a th:href="@{/forgot-password(lang=${'en'})}">EN</a>
  </nav>

  <!-- Title & subtitle -->
  <h1 th:text="#{page.forgotpwd.title}">Forgot Password</h1>
  <p class="muted" th:text="#{page.forgotpwd.subtitle}">
    Enter your email to receive a password reset link.
  </p>

  <!-- Success message -->
  <div th:if="${param.success}" class="ok"
       th:text="#{page.forgotpwd.request.success}">
    If the account exists, a reset link has been sent.
  </div>

  <!-- Error message (rare, en cas de souci JS) -->
  <div th:if="${resetRequestError}" class="alert"
       th:text="${resetRequestError}">
    Une erreur est survenue, merci de réessayer.
  </div>

  <!-- Form to send reset email -->
  <form id="forgot-form">

    <label>
      <span th:text="#{page.forgotpwd.email}">Email</span>
      <input type="email" name="email" required autocomplete="email"/>
    </label>

    <button id="submit-btn" type="submit" th:text="#{page.forgotpwd.request.submit}">
      Envoyer le lien
    </button>

  </form>

  <script>
    (function () {
      const form = document.getElementById('forgot-form');
      const btn  = document.getElementById('submit-btn');

      const COOLDOWN_MS = 5000; // 5 seconds
      let cooldownTimer = null;
      let isSubmitting  = false;

      // read (CookieLocaleResolver)
      function getLocaleFromCookie() {
        return document.cookie
          .split('; ')
          .find(c => c.startsWith('LOCALE='))?.split('=')[1] || 'en';
      }

      // Error text
      function t(key) {
        const lang = getLocaleFromCookie(); // 'fr' | 'en'
        const FR = {
          sending: 'Envoi…',
          send:    'Envoyer le lien',
          retry:   'Réessayer',
          missing: 'Veuillez saisir un email valide.',
          network: 'Erreur réseau, réessayez plus tard.'
        };
        const EN = {
          sending: 'Sending…',
          send:    'Send link',
          retry:   'Retry',
          missing: 'Please enter a valid email.',
          network: 'Network error, please try again later.'
        };
        const dict = (lang && lang.toLowerCase().startsWith('fr')) ? FR : EN;
        return dict[key] ?? key;
      }

      function setButtonState({ disabled, text }) {
        btn.disabled = disabled;
        if (text !== undefined) btn.textContent = text;
        btn.style.opacity = disabled ? '0.7' : '1';
        btn.style.cursor  = disabled ? 'not-allowed' : 'pointer';
      }

      function startCooldown() {
        // Start 5s cooldown after click
        setButtonState({ disabled: true, text: t('sending') });
        cooldownTimer = setTimeout(() => {
          setButtonState({ disabled: false, text: t('send') });
          cooldownTimer = null;
        }, COOLDOWN_MS);
      }

      function cancelCooldownIfAny() {
        if (cooldownTimer) {
          clearTimeout(cooldownTimer);
          cooldownTimer = null;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isSubmitting || btn.disabled) return; // avoid double submit

        const email = e.target.email.value?.trim();
        if (!email) {
          alert(t('missing'));
          return;
        }

        isSubmitting = true;
        startCooldown();

        try {
          const locale = getLocaleFromCookie(); // ← will be 'en' if ur cookie is LOCALE=en

          const res = await fetch('http://localhost:8080/auth/forgot-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept-Language': locale   // I18N key
            },
            // credentials: 'include', // if use cookies cross-site
            body: JSON.stringify({ email })
          });

          // showon sucess message
          window.location.href = '/forgot-password?success=true';

        } catch (err) {
          cancelCooldownIfAny();
          setButtonState({ disabled: false, text: t('retry') });
          alert(t('network'));
        } finally {
          isSubmitting = false;
        }
      });
    })();
  </script>

  <!-- Back to login -->
  <div class="links">
    <a th:href="@{/login}" th:text="#{page.forgotpwd.backtologin}">
      Back to login
    </a>
  </div>

</main>
</body>
</html>