<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="#{page.login.title}">Login</title>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    main { max-width: 420px; margin: 0 auto; }
    h1 { margin-bottom: .5rem; }
    p.muted { color: #6b7280; margin-top: 0; }
    form { display: grid; gap: .75rem; margin-top: 1rem; }
    label { display: grid; gap: .35rem; }
    input { padding: .6rem .75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: .5rem; }
    button { padding: .6rem .9rem; font-size: 1rem; border-radius: .5rem; border: 1px solid transparent; background: #2563eb; color: white; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    .alert { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #f5c6cb; background: #fdecea; color: #611a15; }
    .ok { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #84e1bc; background: #e6ffed; color: #03543f; }
    .links { margin-top: .75rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .input-with-toggle { position: relative; display: grid; }
    .input-with-toggle input { padding-right: 2.4rem; }
    .input-with-toggle button.pw-toggle {
      position: absolute; right: .4rem; top: 50%; transform: translateY(-50%);
      border: none; background: transparent; color: #4b5563; cursor: pointer;
      padding: .25rem; border-radius: .35rem; line-height: 1; font-size: 1.1rem;
    }
    .input-with-toggle button.pw-toggle:hover { background: #f3f4f6; }
    @media (prefers-color-scheme: dark) {
      .input-with-toggle button.pw-toggle:hover { background: #1f2937; }
    }

    .forgot {
      margin-top: .25rem;
      font-size: .92rem;
      display: inline-block;
    }
  </style>

  <!-- Script /static/js -->
  <script defer th:src="@{/js/script_show_pwd.js}"></script>
</head>

<body>
<main>

  <!-- Lang switch -->
  <nav style="margin:.5rem 0 1rem">
    <a th:href="@{/login(lang=${'fr'})}">FR</a> |
    <a th:href="@{/login(lang=${'en'})}">EN</a>
  </nav>

  <!-- Title & subtitle -->
  <h1 th:text="#{page.login.title}">Login</h1>
  <p class="muted" th:text="#{page.login.subtitle}">
    Log in to access the secure area.
  </p>

  <!-- Status messages -->
  <div th:if="${param.registered}" class="ok" th:text="#{page.login.status.registered}">
    Registration successful. You can now log in.
  </div>

  <div th:if="${param.required}" class="alert" th:text="#{page.login.status.required}">
    Please log in to access this page.
  </div>

  <div th:if="${param.logout}" class="ok" th:text="#{page.login.status.logout}">
    You have been logged out.
  </div>

  <div th:if="${param.error} or ${loginError}" class="alert" th:text="#{page.login.status.error}">
    Invalid email or password.
  </div>

  <!-- Client-side error (hidden by default, same text as server-side) -->
  <div id="client-pswd-error"
       class="alert"
       role="alert"
       aria-live="assertive"
       hidden
       th:text="#{page.login.status.error}">
    Invalid email or password.
  </div>

  <!-- Login form -->
  <form th:action="@{/login}" method="post" th:object="${form}">

    <label>
      <span th:text="#{page.login.email}">Email</span>
      <input type="email"
             th:field="*{email}"
             th:placeholder="#{page.login.email.placeholder}"
             autocomplete="username"
             required/>
    </label>

    <label>
      <span th:text="#{page.login.password}">Password</span>
      <div class="input-with-toggle">
        <input id="login-password"
               type="password"
               th:field="*{password}"
               th:placeholder="#{page.login.password.placeholder}"
               autocomplete="current-password"
               required/>
        <button type="button"
                class="pw-toggle"
                data-target="login-password"
                th:attr="aria-label=#{page.login.password.show},
                         title=#{page.login.password.show}"
                aria-pressed="false"
                onclick="togglePasswordIcon(this)">ðŸ™ˆ</button>
      </div>
    </label>

    <button type="submit" th:text="#{page.login.submit}">Log in</button>
  </form>
  
  <a class="forgot"
     th:text="#{page.forgotpwd.title}"
     th:href="@{/forgot-password}">
     Forgot your password?
  </a>

  <!-- Footer links -->
  <div class="links">
    <span th:text="#{page.login.noaccount}">Don't have an account?</span>
    <a th:text="#{page.login.createaccount}" th:href="@{/register}">
      Create an account
    </a>
  </div>

</main>

<script>
  (function () {
    const form = document.querySelector('form[th\\:action="@{/login}"], form[action="/login"]') || document.querySelector('form');
    const passwordInput = document.getElementById('login-password');
    const clientError = document.getElementById('client-pswd-error');

    if (!form || !passwordInput || !clientError) return;

    // pattern 
    const pswdRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,64}$/;

    function showClientError() {
      clientError.hidden = false;
      clientError.tabIndex = -1;
      clientError.focus({ preventScroll: true });
    }

    function hideClientError() {
      if (!clientError.hidden) clientError.hidden = true;
    }

    // clean message
    passwordInput.addEventListener('input', hideClientError);

    form.addEventListener('submit', function (e) {
      const value = passwordInput.value || '';

      if (pswdRegex.test(value)) {
        hideClientError();
        return;
      }

      e.preventDefault();
      showClientError();
    });
  })();
</script>
</body>
</html>