<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="#{page.resetpwd.title}">Reset Password</title>

  <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      main { max-width: 520px; margin: 0 auto; }
      h1 { margin-bottom: .5rem; }
      p.muted { color: #6b7280; margin-top: 0; }
      form { display: grid; gap: .75rem; margin-top: 1rem; }
      label { display: grid; gap: .35rem; }
      input { padding: .6rem .75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: .5rem; }
      button { padding: .6rem .9rem; font-size: 1rem; border-radius: .5rem; border: 1px solid transparent; background: #16a34a; color: white; cursor: pointer; }
      button:hover { background: #15803d; }
      .alert { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #f5c6cb; background: #fdecea; color: #611a15; }
      .ok { padding: .6rem .8rem; border-radius: .5rem; border: 1px solid #84e1bc; background: #e6ffed; color: #03543f; }
      a { color: #2563eb; text-decoration: none; }
      a:hover { text-decoration: underline; }

      .input-with-toggle { position: relative; display: grid; }
      .input-with-toggle input { padding-right: 2.4rem; }
      .input-with-toggle button.pw-toggle {
          position: absolute; right: .4rem; top: 50%; transform: translateY(-50%);
          border: none; background: transparent; color: #4b5563; cursor: pointer;
          padding: .25rem; border-radius: .35rem; line-height: 1; font-size: 1.1rem;
      }
      .input-with-toggle button.pw-toggle:hover { background: #f3f4f6; }
      @media (prefers-color-scheme: dark) {
          .input-with-toggle button.pw-toggle:hover { background: #1f2937; }
      }

      .error-text { color: #b91c1c; font-size: .9rem; display: none; }
      .hint-text  { color: #6b7280; font-size: .9rem; }
      input:is(:invalid).mismatch { border-color: #ef4444; }
      input.valid { border-color: #16a34a; }
  </style>

  <!-- Script  /static/js -->
  <script defer th:src="@{/js/script_show_pwd.js}"></script>
</head>

<body>
<main>

  <!-- Lang switch -->
  <nav style="margin:.5rem 0 1rem">
    <a th:href="@{/reset-password(lang=${'fr'}, token=${token})}">FR</a> |
    <a th:href="@{/reset-password(lang=${'en'}, token=${token})}">EN</a>
  </nav>

  <h1 th:text="#{page.resetpwd.title}">Reset Password</h1>
  <p class="muted" th:text="#{page.resetpwd.subtitle}">
    Enter your new password below.
  </p>

  <!-- Status message -->
  <div id="message" role="status" aria-live="polite"></div>

  <form id="resetForm">
    <!-- TOKEN -->
    <input type="hidden" id="token" name="token" th:value="${token}"/>

    <!-- New password -->
    <label>
      <span th:text="#{page.resetpwd.password}">New password</span>
      <div class="input-with-toggle">
        <input id="newPassword"
               type="password"
               name="newPassword"
               minlength="8"
               maxlength="64"
               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^A-Za-z0-9]).{8,64}$"
               title="8â€“64 caractÃ¨res, avec au moins 1 majuscule, 1 minuscule, 1 chiffre et 1 symbole"
               autocomplete="new-password"
               required>
        <button type="button"
                class="pw-toggle"
                aria-label="Show password"
                aria-pressed="false"
                data-target="newPassword"
                onclick="togglePasswordIcon(this)">ðŸ™ˆ</button>
      </div>
      <span class="hint-text" th:text="#{page.password.policy.hint}">
        Minimum 8 characters, include uppercase, lowercase, number, and symbol.
      </span>
    </label>

    <!-- Confirm password -->
    <label>
      <span th:text="#{page.resetpwd.confirm}">Confirm password</span>
      <div class="input-with-toggle">
        <input id="confirmPassword"
               type="password"
               name="confirmPassword"
               minlength="8"
               maxlength="64"
               autocomplete="new-password"
               required>
        <button type="button"
                class="pw-toggle"
                aria-label="Show password"
                aria-pressed="false"
                data-target="confirmPassword"
                onclick="togglePasswordIcon(this)">ðŸ™ˆ</button>
      </div>

      <span id="pwdHelp" class="error-text" th:text="#{page.register.confirmpassword.error}">
           Passwords do not match.
      </span>
      <span id="policyHelp" class="error-text" th:text="#{page.password.policy.error}">
           The password must be 8â€“64 chars and include uppercase, lowercase, number, and symbol.
      </span>
    </label>

    <button id="submitBtn" type="submit" disabled
            th:text="#{page.resetpwd.submit}">
      Reset password
    </button>
  </form>

  <script>
    const pwd = document.getElementById('newPassword');
    const confirm = document.getElementById('confirmPassword');
    const helpMismatch = document.getElementById('pwdHelp');
    const helpPolicy = document.getElementById('policyHelp');
    const btn = document.getElementById('submitBtn');
    const POLICY_RE = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,64}$/;

    function validate() {
      const hasBoth = pwd.value.length > 0 && confirm.value.length > 0;
      const match = pwd.value === confirm.value;
      const policyOk = POLICY_RE.test(pwd.value);

      // Politic
      if (pwd.value.length > 0 && !policyOk) {
        helpPolicy.style.display = 'block';
        pwd.classList.add('mismatch');
        pwd.classList.remove('valid');
      } else {
        helpPolicy.style.display = 'none';
        pwd.classList.remove('mismatch');
        if (policyOk) pwd.classList.add('valid'); else pwd.classList.remove('valid');
      }

      // Mismatch
      if (hasBoth && !match) {
        helpMismatch.style.display = 'block';
        confirm.classList.add('mismatch');
        confirm.classList.remove('valid');
      } else if (hasBoth && match) {
        helpMismatch.style.display = 'none';
        confirm.classList.remove('mismatch');
        if (policyOk) confirm.classList.add('valid'); else confirm.classList.remove('valid');
      } else {
        helpMismatch.style.display = 'none';
        confirm.classList.remove('mismatch', 'valid');
      }

      btn.disabled = !(policyOk && match);
    }

    // Listen 
    pwd.addEventListener('input', validate);
    confirm.addEventListener('input', validate);

    // Validate init
    validate();

    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      validate();
      if (btn.disabled) return;

      const token = document.getElementById('token').value;
      const newPassword = document.getElementById('newPassword').value;

      try {
        const res = await fetch('http://localhost:8080/auth/reset-password', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ token, newPassword })
        });

        const text = await res.text();
        const message = document.getElementById('message');

        message.className = res.ok ? 'ok' : 'alert';
        message.innerText = text;
      } catch (err) {
        const message = document.getElementById('message');
        message.className = 'alert';
        message.innerText = 'Network error. Please try again.';
      }
    });
  </script>

</main>
</body>
</html>